<!DOCTYPE html>
<html>
    <head>
    
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>The Birth of Flosculus</title>
        
            <link href="//fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
        
        <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="/img/logo.png"/>
        
            
            <link href="http://groovematic.com/feed.xml" rel="alternate" type="application/atom+xml" title="Groovematic" />
        
        <link media="all" href="/css/main.css" rel="stylesheet" />
    
        <meta name="description" content="## A Call For Help

Few days ago, i tweeted this:..." />
        <meta name="keywords" content="" />
    </head>
    <body>
        <section class="site-nav">
    <header>
        <nav id="navigation">
            
            
                <a href="/">Blog</a>
            
                <a href="https://github.com/iromli">Projects</a>
            
                <a href="https://speakerdeck.com/iromli">Talks</a>
            
                <a href="/about/">About</a>
            
        </nav>

        
        <nav class="tagline">
            <span>A moo-saa-fir and his undercover mission</span>
            
                <a href="/" class="btn btn-outline">Groovematic</a>
            
        </nav>
        
    </header>
</section>
    

    <article>
        
        <div class="container">
            <header>
                <div class="meta">
                    By <address><span rel="author" title="Isman Firmansyah">Isman Firmansyah</span> &mdash;
                    <time pubdate datetime="2013-23-November" title="November 23, 2013">November 23, 2013</time>
                </div>
                <h1 class="title">The Birth of Flosculus</h1>
                
            </header>

            <section>
                <h3>A Call For Help</h3>
<p>Few days ago, i tweeted this:</p>
<p><img alt="CPU-blown" class="img-thumbnail" src="/img/2013/11/cpu-blown.png"/></p>
<p>If you notice, the top 2 commands show a huge difference between
CPU usage consumed by Ruby and Python programs — the former is a
<a href="http://fluentd.org/">Fluentd</a>-based script that collects <a href="http://nginx.org/">nginx</a> access log,
parses each line, and sends the data to another Fluentd instance
(in remote server); while the latter is a <a href="http://socket.io/">socket.io</a>
server built on top of <a href="https://github.com/abourget/gevent-socketio">gevent-socketio</a> —
in AWS EC2 micro instance.</p>
<p>I was wondering what went wrong?
Hence i looked up to the official <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts_micro_instances.html#when-instance-uses-allotted-resources">AWS EC2 doc&shy;u&shy;men&shy;ta&shy;tion</a>
to find any hint, and stumbled upon a line:</p>
<blockquote>
<p>Limit the number of recurring processes that use CPU time (for example, cron jobs, daemons)</p>
</blockquote>
<p>That's strange!! Both are daemonized long-running programs, but why the Ruby script blown the CPU?
Do i need to have a bigger box for a small service
and convince my employer to spend more money?</p>
<h3>First Attempt: Becoming A Rubyist</h3>
<p>That day, i was reading the sourcecode trying to figure out
how Fluentd works internally. <strong>And i failed!!</strong></p>
<p>As you might have known, i know nothing about Ruby nowadays — my Ruby days were long gone.
Please don't get me wrong, Ruby is a sexy pro&shy;gram&shy;ming language.
But you know what, not all people able to deal with the <em>hottie</em> for a long-term re&shy;la&shy;tion&shy;ship.</p>
<p><img alt="nosebleed" class="img-thumbnail" src="/img/2013/11/nosebleed-anime.jpg"/></p>
<h3>Second Attempt: Keep Calm &amp; Move On</h3>
<p>At the same day, i suddenly remembered about a Python library called <a href="https://github.com/josegonzalez/beaver">Beaver</a>.
From its repository page, Beaver is best described as:</p>
<blockquote>
<p>python daemon that munches on logs and sends their contents to logstash</p>
</blockquote>
<p>Obviously, Beaver acts as a <a href="http://logstash.net/">Logstash</a> input plugin.
Well, i can haz Beaver for Fluentd?</p>
<h4>Looking At The Big Picture</h4>
<p>So i sat down and read the internal doc&shy;u&shy;men&shy;ta&shy;tion on how <a href="http://www.beautiplan.com/">Beautiplan</a>
in&shy;fra&shy;struc&shy;ture are made of — especially the logging files management section.
Anyway, here's the schema with a little detail for each component:</p>
<p><img alt="schema" class="img-thumbnail" src="/img/2013/11/schema.png"/></p>
<ol>
<li>
<h5>forwarder</h5>
<p><em>forwarder</em> is a daemonized program. Its main job is tailing a rotated log file,
parse each line, and send the result to <em>aggregator</em> elsewhere.
Just imagine a <code>tail -F scarry.log</code> command with steroid.
Fluentd, Beaver, or your own script fits the job, as long as it knows
how to speak to <em>aggregator</em>.</p>
</li>
<li>
<h5>aggregator</h5>
<p>Actually <em>aggregator</em> is the first-class citizen here.
Everything is setup to match its behavior.
Its job is to receive incoming data — usually a JSON — do some works,
and send the result elsewhere, either a simple <em>stdout</em> or remote <em>datastore</em>.
Fluentd, Logstash, or even <a href="https://github.com/mozilla-services/heka">Heka</a> will do the job for you.</p>
</li>
<li>
<h5>datastore</h5>
<p>The <em>datastore</em> stores (dooh) the timeseries data extracted from a log.
It's <a href="http://elasticsearch.org/">Elas&shy;tic&shy;Search</a> by the way. Other datastores might work.</p>
</li>
<li>
<h5>frontend</h5>
<p>Remember the old days when you have to stare hundred lines of a log file (bad)
or doing shell command and pipeline magic (better) to know what's really
going on in your production-ready ap&shy;pli&shy;ca&shy;tion?
Enter <a href="http://rashidkpc.github.io/Kibana/">Kibana</a> or <a href="http://www.elasticsearch.org/overview/kibana/">Kibana 3</a> then!
I think you'll like this web-based log vi&shy;su&shy;al&shy;iza&shy;tion app.</p>
</li>
</ol>
<p>Given the schema above, i realized that i need to replace <em>forwarder</em> with
Beaver-like library. After all, the box where current <em>forwarder</em> program lives
right now, is a server where it has plenty of Python-based scripts there.
So i though, let's add yet another Python script.</p>
<h3>Current Status: Flosculus in Action</h3>
<p>At its core, Beaver uses <a href="http://code.activestate.com/recipes/577968-log-watcher-tail-f-log/">this script</a> (MIT-licensed).
So i took down that one, combined with <a href="https://github.com/fluent/fluent-logger-python">Python binding for Fluentd</a>,
did some mod&shy;i&shy;fi&shy;ca&shy;tion, and voila ... it's <a href="https://github.com/iromli/flosculus">Flosculus</a>.
Flosculus is very young and definetely will need lots of en&shy;hance&shy;ments.
But it's already running in production though.</p>
<p>Yes, i know some of you might said, <em>"Dont reinvent the wheel"</em>.
But what if the wheels aren't exactly what i need?</p>
<p><img alt="bicycle" class="img-thumbnail" src="/img/2013/11/bicycle.jpg"/></p>
<p>In the end, Flosculus is my attempt to create something like Beaver or Fluentd <code>in_tail</code> plugin.
I wanna see it grows (or likely dies pre&shy;ma&shy;ture&shy;ly). The future is far beyond.</p>
                
                    <div class="social">
                        <div>
                            <a href="https://twitter.com/share" class="twitter-share-button"  data-text="The Birth of Flosculus" data-related="iromli">Tweet</a>
                        </div>
                        

                        

                        
                        <div>
                            <div class="g-plusone" data-size="medium"></div>
                        </div>
                        
                    </div>
                
            </section>

            <footer>
                <address>
                    <img src="/img/authors/iromli.jpeg">
                    Written by <strong><a rel="author" href="/" title="Isman Firmansyah">Isman Firmansyah</a></strong><br>
                    <span class="muted"></span>
                    
                        <div class="follow">
                            <a href="https://twitter.com/iromli" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @</a>
                            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                        </div>
                    
                </address>
            </footer>
            
            <section id="disqus_thread"></section>
            
        </div>
    </article>
<footer class="site-footer">
    <div class="container">
        &copy; 2014

        
            <nav>
            
                <a href="/">Blog</a> &middot;
            
                <a href="https://github.com/iromli">Projects</a> &middot;
            
                <a href="https://speakerdeck.com/iromli">Talks</a> &middot;
            
                <a href="/about/">About</a> 
            
            </nav>
        

        <nav class="social">
            
            <a href="https://twitter.com/iromli" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
                
                <a href="/feed.xml" title="Atom Feed">
                    <i class="icon icon-rss black"></i>
                </a>
            
        </nav>
        
            <p><em><a href='https://github.com/iromli/groovematic'>Use the source, Luke!</a></em></p>
        
    </div>
</footer>
        
    
            <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        
    
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'groovematic'; // required: replace example with your forum shortname
            if (window.location.hostname != 'localhost') {
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function () {
                    var s = document.createElement('script'); s.async = true;
                    s.type = 'text/javascript';
                    s.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);}());
            }
        </script>
    
    
    <script>
        !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
    </script>





    <script type="text/javascript">
        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>


    </body>
</html>