<!doctype html>
<html lang="en">
<head>
    <title>The Birth of Flosculus</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/css/pure-min.css" rel="stylesheet" type="text/css">
        <link href="/css/style.css" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
        <meta name="author" content="Isman Firmansyah">
        
    <meta name="description" content="## A Call For Help

Few days ago, i tweeted this:..." />
    <meta name="keywords" content="" />
</head>
<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <header class="header">
                <hgroup>
                    <h1 class="brand-title">groovematic</h1>
                </hgroup>
                <nav class="nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="pure-button" href="/">Archives</a>
                        </li>
                        <li class="nav-item">
                            <a class="pure-button" href="/atom.xml">Feeds</a>
                        </li>
                    </ul>
                </nav>
            </header>
        </div>

        <div class="pure-u-1">
            <div class="content">
                
    
    <div class="posts">
        <section class="post">
            <header class="post-header">
                <h2 class="post-title">The Birth of Flosculus</h2>
                <div class="content-subhead">
                    <em>Saturday, November 23, 2013</em>
                </div>
            </header>

            <div class="post-description">
                <p><h2>A Call For Help</h2>
<p>Few days ago, i tweeted this:</p>
<p><img alt="CPU-blown" class="thumbnail" src="/img/2013/11/cpu-blown.png" /></p>
<p>If you notice, the top 2 commands show a huge difference between
CPU usage consumed by Ruby and Python programs — the former is a
<a href="http://fluentd.org/">Fluentd</a>-based script that collects <a href="http://nginx.org/">nginx</a> access log,
parses each line, and sends the data to another Fluentd instance
(in remote server); while the latter is a <a href="http://socket.io/">socket.io</a>
server built on top of <a href="https://github.com/abourget/gevent-socketio">gevent-socketio</a> —
in AWS EC2 micro instance.</p>
<p>I was wondering what went wrong?
Hence i looked up to the official <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts_micro_instances.html#when-instance-uses-allotted-resources">AWS EC2 documentation</a>
to find any hint, and stumbled upon a line:</p>
<blockquote>
<p>Limit the number of recurring processes that use CPU time (for example, cron jobs, daemons)</p>
</blockquote>
<p>That's strange!! Both are daemonized long-running programs, but why the Ruby script blown the CPU?
Do i need to have a bigger box for a small service
and convince my employer to spend more money?</p>
<h2>First Attempt: Becoming A Rubyist</h2>
<p>That day, i was reading the sourcecode trying to figure out
how Fluentd works internally. <strong>And i failed!!</strong></p>
<p>As you might have known, i know nothing about Ruby nowadays — my Ruby days were long gone.
Please don't get me wrong, Ruby is a sexy programming language.
But you know what, not all people able to deal with the <em>hottie</em> for a long-term relationship.</p>
<p><img alt="nosebleed" class="thumbnail" src="/img/2013/11/nosebleed-anime.jpg" /></p>
<h2>Second Attempt: Keep Calm &amp; Move On</h2>
<p>At the same day, i suddenly remembered about a Python library called <a href="https://github.com/josegonzalez/beaver">Beaver</a>.
From its repository page, Beaver is best described as:</p>
<blockquote>
<p>python daemon that munches on logs and sends their contents to logstash</p>
</blockquote>
<p>Obviously, Beaver acts as a <a href="http://logstash.net/">Logstash</a> input plugin.
Well, i can haz Beaver for Fluentd?</p>
<h3>Looking At The Big Picture</h3>
<p>So i sat down and read the internal documentation on how <a href="http://www.beautiplan.com/">Beautiplan</a>
infrastructure are made of — especially the logging files management section.
Anyway, here's the schema with a little detail for each component:</p>
<p><img alt="schema" class="thumbnail" src="/img/2013/11/schema.png" /></p>
<ol>
<li>
<h4>forwarder</h4>
<p><em>forwarder</em> is a daemonized program. Its main job is tailing a rotated log file,
parse each line, and send the result to <em>aggregator</em> elsewhere.
Just imagine a <code>tail -F scarry.log</code> command with steroid.
Fluentd, Beaver, or your own script fits the job, as long as it knows
how to speak to <em>aggregator</em>.</p>
</li>
<li>
<h4>aggregator</h4>
<p>Actually <em>aggregator</em> is the first-class citizen here.
Everything is setup to match its behavior.
Its job is to receive incoming data — usually a JSON — do some works,
and send the result elsewhere, either a simple <em>stdout</em> or remote <em>datastore</em>.
Fluentd, Logstash, or even <a href="https://github.com/mozilla-services/heka">Heka</a> will do the job for you.</p>
</li>
<li>
<h4>datastore</h4>
<p>The <em>datastore</em> stores (dooh) the timeseries data extracted from a log.
It's <a href="http://elasticsearch.org/">ElasticSearch</a> by the way. Other datastores might work.</p>
</li>
<li>
<h4>frontend</h4>
<p>Remember the old days when you have to stare hundred lines of a log file (bad)
or doing shell command and pipeline magic (better) to know what's really
going on in your production-ready application?
Enter <a href="http://rashidkpc.github.io/Kibana/">Kibana</a> or <a href="http://www.elasticsearch.org/overview/kibana/">Kibana 3</a> then!
I think you'll like this web-based log visualization app.</p>
</li>
</ol>
<p>Given the schema above, i realized that i need to replace <em>forwarder</em> with
Beaver-like library. After all, the box where current <em>forwarder</em> program lives
right now, is a server where it has plenty of Python-based scripts there.
So i though, let's add yet another Python script.</p>
<h2>Current Status: Flosculus in Action</h2>
<p>At its core, Beaver uses <a href="http://code.activestate.com/recipes/577968-log-watcher-tail-f-log/">this script</a> (MIT-licensed).
So i took down that one, combined with <a href="https://github.com/fluent/fluent-logger-python">Python binding for Fluentd</a>,
did some modification, and voila ... it's <a href="https://github.com/iromli/flosculus">Flosculus</a>.
Flosculus is very young and definetely will need lots of enhancements.
But it's already running in production though.</p>
<p>Yes, i know some of you might said, <em>"Dont reinvent the wheel"</em>.
But what if the wheels aren't exactly what i need?</p>
<p><img alt="bicycle" class="thumbnail" src="/img/2013/11/bicycle.jpg" /></p>
<p>In the end, Flosculus is my attempt to create something like Beaver or Fluentd <code>in_tail</code> plugin.
I wanna see it grows (or likely dies prematurely). The future is far beyond.</p></p>
            </div>
        </section>
    </div>

    <div class="neighbors">
        
        <div class="pull-left">
            <span>&larr;</span>&nbsp;<a href="/2013/07/introducing-genma/">prev</a>
        </div>
        
        
        <div style="clear:both;"></div>
    </div>
    

                
    
    
        <div id="disqus_thread"></div>
    

                <div class="footer">
                    <div class="pure-menu pure-menu-horizontal pure-menu-open">
                        <p id="legal">Groovematic &copy; 2013</p>
                        <ul>
                            <li>
                                <a href="/about/">Who Am I?</a>
                            </li>
                            <li>
                                <a href="https://github.com/iromli/groovematic" target="_blank">Use The Source, Luke!</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        if (window.location.hostname != 'localhost') {
            var dq_container = document.getElementById('disqus_thread');

            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            // required: replace example with your forum shortname
            var disqus_shortname = "groovematic";

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();

            dq_container.style['padding-top'] = '40px';
            dq_container.style['margin-bottom'] = '40px';
            dq_container.style['border-top'] = 'dashed 1px #DDD';
        }
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    <script>
        if (window.location.hostname != 'localhost') {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-34241156-1', 'groovematic.com');
            ga('send', 'pageview');
        }
    </script>
</body>
</html>