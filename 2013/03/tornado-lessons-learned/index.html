<!doctype html>
<html lang="en">
<head>
    <title>Tornado, Lessons Learned</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/css/pure-min.css" rel="stylesheet" type="text/css">
        <link href="/css/style.css" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
        <meta name="author" content="Isman Firmansyah">
        
    <meta name="description" content="## Back In The Days

Last year, during [SixReps][s..." />
    <meta name="keywords" content="python" />
</head>
<body>
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <header class="header">
                <hgroup>
                    <h1 class="brand-title">groovematic</h1>
                </hgroup>
                <nav class="nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="pure-button" href="/">Archives</a>
                        </li>
                        <li class="nav-item">
                            <a class="pure-button" href="/atom.xml">Feeds</a>
                        </li>
                    </ul>
                </nav>
            </header>
        </div>

        <div class="pure-u-1">
            <div class="content">
                
    
    <div class="posts">
        <section class="post">
            <header class="post-header">
                <h2 class="post-title">Tornado, Lessons Learned</h2>
                <div class="content-subhead">
                    <em>Monday, March 04, 2013</em>&nbsp;&raquo;&nbsp;<span>
                        <a href="/tags/python/" rel="tag">python</a>
                        
                        </span>
                    
                </div>
            </header>

            <div class="post-description">
                <p><h2>Back In The Days</h2>
<p>Last year, during <a href="http://www.sixreps.com">SixReps</a> days, me and Tino (<a href="http://twitter.com/kusut">@kusut</a>)
worked on and maintained a project built on top of <a href="http://tornadoweb.org/">Tornado</a>.
The project itself is a web service that accepts 3rd-party apps request
and serves the response through HTTP.
We used MySQL as primary datasource, <a href="http://redis.io/">Redis</a> for caches and queues,
and Amazon S3 to store uploaded images.
We were happy enough to see that our stack is running well for our usecase.</p>
<p><strong>FYI</strong>, both of us aren't worked on that project any longer.</p>
<h2>For Your Consideration</h2>
<p>I'm not going to go deeper about our implementation nor Tornado API itself
(i'm not a Tornado guru yet, perhaps someday in future?).
Instead, i will share lessons learned after using this nifty framework.
The idea is to notify newcomers about gotchas they might encounter
and tradeoffs they should aware of when using Tornado.</p>
<p>Basically, before starting any serious work using Tornado,
you should ask yourself these questions:</p>
<ol>
<li>Does your app need to be synchronous/asynchronous?</li>
<li>Do you comfortable with callback-style programming?</li>
</ol>
<h2>Being Synchronous (Is Mostly Fine)</h2>
<p>If your app doesn't care about being asynchronous, you can start writing code
immediately.
You might wondering why bother yourself using something that written for
asynchronous, but you don't even care about asynchronous at all?</p>
<ol>
<li>Tornado is not a full-stack framework. It's simple, well-written, and well-documented.
    By reading the sourcecode itself, you'll understand how it works ... eventually.</li>
<li>Tornado has its own web framework (much like <a href="http://webpy.org/">web.py</a>).</li>
<li>Tornado has its own templating language (quite similar to <a href="http://jinja.pocoo.org/">Jinja</a>).</li>
<li>Tornado has its own web server.</li>
<li>The most important things, you can use (almost?) any Python library, even if it's not written specifically for Tornado.</li>
</ol>
<p>Let me show you snippets to illustrate point 2 - 4. First things first, create
<code>app.py</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kn">import</span> <span class="nn">tornado.web</span>          <span class="c"># the Tornado web framework</span>
<span class="kn">import</span> <span class="nn">tornado.httpserver</span>   <span class="c"># the Tornado web server</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>       <span class="c"># the Tornado event-loop</span>

<span class="c"># handles incoming request, this is the C part in MVC</span>
<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># renders the Tornado template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;homepage.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;John Doe&#39;</span><span class="p">)</span>

<span class="c"># prepares the application</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
    <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">template_path</span><span class="o">=</span><span class="s">&#39;templates&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># prepares the web server</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">xheaders</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># listens incoming request on port 8000</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># starts the server using 1 process</span>
    <span class="c"># unless you know what you&#39;re doing, always set to 1</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># runs all the things</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>Before running the app, make sure you have <code>homepage.html</code> template, located
under <code>templates</code> directory:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span class="nt">&lt;h1&gt;</span>Greeting from Tornado<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Hello, {{ user }}<span class="nt">&lt;/p&gt;</span>
</pre></div>
</td></tr></table>

<p>Run the app by typing <code>python app.py</code> in your console, and go to <code>http://localhost:8000/</code>.
Now you already have a synchronous app built on top of Tornado.
Pretty straight-forward isn't it?</p>
<p>So, what's the <em>tradeoff of being synchronous</em>?
You'll lose the power of Tornado event-loop itself, of course.
Some users claimed they use a combination of <a href="https://www.djangoproject.com/">Django</a>/<a href="http://flask.pocoo.org">Flask</a> and Tornado.
It's true that Tornado has a WSGI-compatible web server,
but you can't expect your app to go asynchronously out-of-the-box
by simply running it behind the Tornado web server.</p>
<h2>Going Asynchronous (Or How To Not Blocking The IOLoop)</h2>
<p>I already mentioned <code>tornado.ioloop.IOLoop</code> on previous section.
Basically, IOLoop is a Tornado binding to the underlying event-loop
(<code>epoll</code> on Linux and <code>kqueue</code> on BSD).
I don't know about Windows support, but there's a project
called <a href="https://github.com/saghul/tornado-pyuv">tornado-pyuv</a> that utilizes <code>libuv</code> to provide event-loop that runs
on all platforms.</p>
<p>You have to be very careful when writing asynchronous app using Tornado.
Your simple code that uses <code>stdlib</code> callables or 3rd-party libraries might blocking the IOLoop.
How do we know IOLoop is blocked?
It's hard, but what i was doing back in the days is testing against 2 incoming requests.
If a request must wait for another request to finish, then IOLoop is blocked.</p>
<p>To illustrate <code>stdlib</code> callable which blocks IOLoop:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.httpserver</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;http://groovematic.com/&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_finish</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SleepHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>           <span class="c"># time.sleep is blocking IOLoop, dooh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
        <span class="p">(</span><span class="s">r&quot;/t&quot;</span><span class="p">,</span> <span class="n">SleepHandler</span><span class="p">),</span>
    <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">xheaders</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>Open up your console, type <code>curl http://localhost:8000/t</code>.
In separate window, type <code>curl http://localhost:8000/</code>.
You'll see that <code>/</code> have to wait <code>/t</code> to finish its request-response cyle
within 3 seconds.
Fortunately, there's Tornado equivalent to <code>time.sleep</code>.
Please have a look at <code>IOLoop.add_timeout</code> API.</p>
<p>To be honest, 3rd-party libraries written specifically for Tornado is not as
much as, let say, Django.
You have to dig into <a href="https://github.com/facebook/tornado/wiki/Links">Tornado wiki</a>,
<a href="https://github.com/">GitHub</a>, <a href="https://bitbucket.org/">Bitbucket</a>,
<a href="http://tornadogists.org/">Tornado gist</a>, or somewhere else
(IRC/mailing list/search engine) to find what you're looking for.</p>
<p>If for some reasons you must use blocking library, you have options to run the
blocking execution in separate process,
either using <a href="http://tornadogists.org/2894704/">threading</a>, <a href="http://tornadogists.org/2185380/">multiprocessing</a>,
or <a href="http://tornadogists.org/3849257/">queue</a>.
The implementation may vary, but they share a same concept:</p>
<ol>
<li>Wrap the blocking execution and give the control back to IOLoop immediately.</li>
<li>Run the blocking execution in separate process.</li>
<li>Notify and/or send the result of blocking execution back to IOLoop.</li>
</ol>
<p>So, what's the <em>tradeoff of going asynchronous</em>?
Once you're using blocking library, IOLoop is blocked.
Depending on your usecase, it might be bad for your business.
That's a price to pay.</p>
<h2>Callbacks Spaghetti? Fear No More!</h2>
<p>To me, the most tricky part of Tornado (in general) and IOLoop (especially),
is dealing with callbacks.
If you came from JavaScript or other programming languages emphasizing
callback-style programming, you'll know what callback is.</p>
<p>Lets take a look an example below:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;http://groovematic.com/&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_finish</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>Nothing's wrong isn't it? But what if you want to get the result directly
instead of using callback?
You shouldn't worry that much, there's <code>tornado.gen</code> module which simplifies things.
It helps you write a non-callback-style code.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="codehilite"><pre><span class="kn">import</span> <span class="nn">tornado.gen</span>
<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="nd">@tornado.gen.engine</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tornado</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">,</span> <span class="s">&#39;http://groovematic.com/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>Yay, it looks better now. Say goodbye to callbacks spaghetti then.</p>
<h2>Morals Of The Story</h2>
<ol>
<li>You don't care about asynchronous but still wanna use Tornado? Just do it.</li>
<li>You have things for asynchronous and wanna use Tornado? Do it carefully.</li>
<li>You don't like callbacks when writing Tornado-based app? Use helpers.</li>
</ol>
<p><strong>PS</strong>: Eventually you'll get this Tornado thingy sooner or later.
You might roll your own IOLoop-compatible library someday (i wrote <a href="https://github.com/iromli/dusky">dusky</a>).
It's always fun to learn something new. Trust me, i've been there, done that.</p></p>
            </div>
        </section>
    </div>

    <div class="neighbors">
        
        <div class="pull-left">
            <span>&larr;</span>&nbsp;<a href="/2013/01/welcoming-acrylamid/">prev</a>
        </div>
        
        
        <div class="pull-right">
            <a href="/2013/07/introducing-genma/">next</a>&nbsp;<span>&rarr;</span>
        </div>
        
        <div style="clear:both;"></div>
    </div>
    

                
    
    
        <div id="disqus_thread"></div>
    

                <div class="footer">
                    <div class="pure-menu pure-menu-horizontal pure-menu-open">
                        <p id="legal">Groovematic &copy; 2013</p>
                        <ul>
                            <li>
                                <a href="/about/">Who Am I?</a>
                            </li>
                            <li>
                                <a href="https://github.com/iromli/groovematic" target="_blank">Use The Source, Luke!</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        if (window.location.hostname != 'localhost') {
            var dq_container = document.getElementById('disqus_thread');

            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            // required: replace example with your forum shortname
            var disqus_shortname = "groovematic";

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();

            dq_container.style['padding-top'] = '40px';
            dq_container.style['margin-bottom'] = '40px';
            dq_container.style['border-top'] = 'dashed 1px #DDD';
        }
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    <script>
        if (window.location.hostname != 'localhost') {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-34241156-1', 'groovematic.com');
            ga('send', 'pageview');
        }
    </script>
</body>
</html>