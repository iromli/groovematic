<!DOCTYPE html>
<html>
    <head>
    
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Tornado, Lessons Learned</title>
        
            <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
        
        <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="/img/logo.png"/>
        
            
            <link href="http://groovematic.com/feed.xml" rel="alternate" type="application/atom+xml" title="Groovematic" />
        
        <link media="all" href="/css/main.css" rel="stylesheet" />
    
        <meta name="description" content="## Back In The Days

Last year, during [SixReps][s..." />
        <meta name="keywords" content="" />
    </head>
    <body>
        <section class="site-nav">
    <header>
        <nav id="navigation">
            
            
                <a href="/">Blog</a>
            
                <a href="https://github.com/iromli">Projects</a>
            
                <a href="https://speakerdeck.com/iromli">Talks</a>
            
                <a href="/about/">About</a>
            
        </nav>

        
        <nav class="tagline">
            <span>A moo-saa-fir and his undercover mission</span>
            
                <a href="/" class="btn btn-outline">Groovematic</a>
            
        </nav>
        
    </header>
</section>
    

    <article>
        
        <div class="container">
            <header>
                <div class="meta">
                    By <address><span rel="author" title="Isman Firmansyah">Isman Firmansyah</span> &mdash;
                    <time pubdate datetime="2013-04-March" title="March 04, 2013">March 04, 2013</time>
                </div>
                <h1 class="title">Tornado, Lessons Learned</h1>
                
            </header>

            <section>
                <h3>Back In The Days</h3>
<p>Last year, during <a href="http://www.sixreps.com">SixReps</a> days, me and Tino (<a href="http://twitter.com/kusut">@kusut</a>)
worked on and maintained a project built on top of <a href="http://tornadoweb.org/">Tornado</a>.
The project itself is a web service that accepts 3rd-party apps request
and serves the response through HTTP.
We used MySQL as primary datasource, <a href="http://redis.io/">Redis</a> for caches and queues,
and Amazon S3 to store uploaded images.
We were happy enough to see that our stack is running well for our usecase.</p>
<p><strong>FYI</strong>, both of us aren't worked on that project any longer.</p>
<h3>For Your Con&shy;sid&shy;er&shy;a&shy;tion</h3>
<p>I'm not going to go deeper about our im&shy;ple&shy;men&shy;ta&shy;tion nor Tornado API itself
(i'm not a Tornado guru yet, perhaps someday in future?).
Instead, i will share lessons learned after using this nifty framework.
The idea is to notify newcomers about gotchas they might encounter
and tradeoffs they should aware of when using Tornado.</p>
<p>Basically, before starting any serious work using Tornado,
you should ask yourself these questions:</p>
<ol>
<li>Does your app need to be syn&shy;chro&shy;nous/asyn&shy;chro&shy;nous?</li>
<li>Do you com&shy;fort&shy;able with callback-style pro&shy;gram&shy;ming?</li>
</ol>
<h3>Being Syn&shy;chro&shy;nous (Is Mostly Fine)</h3>
<p>If your app doesn't care about being asyn&shy;chro&shy;nous, you can start writing code
im&shy;me&shy;di&shy;ate&shy;ly.
You might wondering why bother yourself using something that written for
asyn&shy;chro&shy;nous, but you don't even care about asyn&shy;chro&shy;nous at all?</p>
<ol>
<li>Tornado is not a full-stack framework. It's simple, well-written, and well-documented.
    By reading the sourcecode itself, you'll understand how it works ... eventually.</li>
<li>Tornado has its own web framework (much like <a href="http://webpy.org/">web.py</a>).</li>
<li>Tornado has its own templating language (quite similar to <a href="http://jinja.pocoo.org/">Jinja</a>).</li>
<li>Tornado has its own web server.</li>
<li>The most important things, you can use (almost?) any Python library, even if it's not written specif&shy;i&shy;cal&shy;ly for Tornado.</li>
</ol>
<p>Let me show you snippets to illustrate point 2 - 4. First things first, create
<code>app.py</code>:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tornado.web</span>          <span class="c"># the Tornado web framework</span>
<span class="kn">import</span> <span class="nn">tornado.httpserver</span>   <span class="c"># the Tornado web server</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>       <span class="c"># the Tornado event-loop</span>

<span class="c"># handles incoming request, this is the C part in MVC</span>
<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># renders the Tornado template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;homepage.html&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;John Doe&#39;</span><span class="p">)</span>

<span class="c"># prepares the application</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
    <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">template_path</span><span class="o">=</span><span class="s">&#39;templates&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c"># prepares the web server</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">xheaders</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c"># listens incoming request on port 8000</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="c"># starts the server using 1 process</span>
    <span class="c"># unless you know what you&#39;re doing, always set to 1</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># runs all the things</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>Before running the app, make sure you have <code>homepage.html</code> template, located
under <code>templates</code> directory:</p>
<div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Greeting from Tornado<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Hello, {{ user }}<span class="nt">&lt;/p&gt;</span>
</pre></div>


<p>Run the app by typing <code>python app.py</code> in your console, and go to <code>http://localhost:8000/</code>.
Now you already have a syn&shy;chro&shy;nous app built on top of Tornado.
Pretty straight-forward isn't it?</p>
<p>So, what's the <em>tradeoff of being syn&shy;chro&shy;nous</em>?
You'll lose the power of Tornado event-loop itself, of course.
Some users claimed they use a com&shy;bi&shy;na&shy;tion of <a href="https://www.djangoproject.com/">Django</a>/<a href="http://flask.pocoo.org">Flask</a> and Tornado.
It's true that Tornado has a WSGI-compatible web server,
but you can't expect your app to go asyn&shy;chro&shy;nous&shy;ly out-of-the-box
by simply running it behind the Tornado web server.</p>
<h3>Going Asyn&shy;chro&shy;nous (Or How To Not Blocking The IOLoop)</h3>
<p>I already mentioned <code>tornado.ioloop.IOLoop</code> on previous section.
Basically, IOLoop is a Tornado binding to the underlying event-loop
(<code>epoll</code> on Linux and <code>kqueue</code> on BSD).
I don't know about Windows support, but there's a project
called <a href="https://github.com/saghul/tornado-pyuv">tornado-pyuv</a> that utilizes <code>libuv</code> to provide event-loop that runs
on all platforms.</p>
<p>You have to be very careful when writing asyn&shy;chro&shy;nous app using Tornado.
Your simple code that uses <code>stdlib</code> callables or 3rd-party libraries might blocking the IOLoop.
How do we know IOLoop is blocked?
It's hard, but what i was doing back in the days is testing against 2 incoming requests.
If a request must wait for another request to finish, then IOLoop is blocked.</p>
<p>To illustrate <code>stdlib</code> callable which blocks IOLoop:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.httpserver</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;http://groovematic.com/&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_finish</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SleepHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>           <span class="c"># time.sleep is blocking IOLoop, dooh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([</span>
        <span class="p">(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
        <span class="p">(</span><span class="s">r&quot;/t&quot;</span><span class="p">,</span> <span class="n">SleepHandler</span><span class="p">),</span>
    <span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">xheaders</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>Open up your console, type <code>curl http://localhost:8000/t</code>.
In separate window, type <code>curl http://localhost:8000/</code>.
You'll see that <code>/</code> have to wait <code>/t</code> to finish its request-response cyle
within 3 seconds.
For&shy;tu&shy;nate&shy;ly, there's Tornado equivalent to <code>time.sleep</code>.
Please have a look at <code>IOLoop.add_timeout</code> API.</p>
<p>To be honest, 3rd-party libraries written specif&shy;i&shy;cal&shy;ly for Tornado is not as
much as, let say, Django.
You have to dig into <a href="https://github.com/facebook/tornado/wiki/Links">Tornado wiki</a>,
<a href="https://github.com/">GitHub</a>, <a href="https://bitbucket.org/">Bitbucket</a>,
<a href="http://tornadogists.org/">Tornado gist</a>, or somewhere else
(IRC/mailing list/search engine) to find what you're looking for.</p>
<p>If for some reasons you must use blocking library, you have options to run the
blocking execution in separate process,
either using <a href="http://tornadogists.org/2894704/">threading</a>, <a href="http://tornadogists.org/2185380/">mul&shy;ti&shy;pro&shy;cess&shy;ing</a>,
or <a href="http://tornadogists.org/3849257/">queue</a>.
The im&shy;ple&shy;men&shy;ta&shy;tion may vary, but they share a same concept:</p>
<ol>
<li>Wrap the blocking execution and give the control back to IOLoop im&shy;me&shy;di&shy;ate&shy;ly.</li>
<li>Run the blocking execution in separate process.</li>
<li>Notify and/or send the result of blocking execution back to IOLoop.</li>
</ol>
<p>So, what's the <em>tradeoff of going asyn&shy;chro&shy;nous</em>?
Once you're using blocking library, IOLoop is blocked.
Depending on your usecase, it might be bad for your business.
That's a price to pay.</p>
<h3>Callbacks Spaghetti? Fear No More!</h3>
<p>To me, the most tricky part of Tornado (in general) and IOLoop (especially),
is dealing with callbacks.
If you came from JavaScript or other pro&shy;gram&shy;ming languages em&shy;pha&shy;siz&shy;ing
callback-style pro&shy;gram&shy;ming, you'll know what callback is.</p>
<p>Lets take a look an example below:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s">&#39;http://groovematic.com/&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_finish</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>


<p>Nothing's wrong isn't it? But what if you want to get the result directly
instead of using callback?
You shouldn't worry that much, there's <code>tornado.gen</code> module which simplifies things.
It helps you write a non-callback-style code.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">tornado.gen</span>
<span class="kn">import</span> <span class="nn">tornado.httpclient</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>

<span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="nd">@tornado.gen.engine</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpclient</span><span class="o">.</span><span class="n">AsyncHTTPClient</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tornado</span><span class="o">.</span><span class="n">gen</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">fetch</span><span class="p">,</span> <span class="s">&#39;http://groovematic.com/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>


<p>Yay, it looks better now. Say goodbye to callbacks spaghetti then.</p>
<h3>Morals Of The Story</h3>
<ol>
<li>You don't care about asyn&shy;chro&shy;nous but still wanna use Tornado? Just do it.</li>
<li>You have things for asyn&shy;chro&shy;nous and wanna use Tornado? Do it carefully.</li>
<li>You don't like callbacks when writing Tornado-based app? Use helpers.</li>
</ol>
<p><strong>PS</strong>: Eventually you'll get this Tornado thingy sooner or later.
You might roll your own IOLoop-compatible library someday (i wrote <a href="https://github.com/iromli/dusky">dusky</a>).
It's always fun to learn something new. Trust me, i've been there, done that.</p>
                
                    <div class="social">
                        <div>
                            <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Tornado, Lessons Learned" data-related="iromli">Tweet</a>
                        </div>
                        

                        

                        
                        <div>
                            <div class="g-plusone" data-size="medium"></div>
                        </div>
                        
                    </div>
                
            </section>

            <footer>
                <address>
                    <img src="/img/authors/iromli.jpeg">
                    Written by <strong><a rel="author" href="/" title="Isman Firmansyah">Isman Firmansyah</a></strong><br>
                    <span class="muted"></span>
                    
                        <div class="follow">
                            <a href="https://twitter.com/iromli" class="twitter-follow-button" data-show-count="false" data-dnt="true">Follow @</a>
                            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                        </div>
                    
                </address>
            </footer>
            
            <section id="disqus_thread"></section>
            
        </div>
    </article>
<footer class="site-footer">
    <div class="container">
        &copy; 2014

        
            <nav>
            
                <a href="/">Blog</a> &middot;
            
                <a href="https://github.com/iromli">Projects</a> &middot;
            
                <a href="https://speakerdeck.com/iromli">Talks</a> &middot;
            
                <a href="/about/">About</a> 
            
            </nav>
        

        <nav class="social">
            
            <a href="https://twitter.com/iromli" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
            
                
                <a href="/feed.xml" title="Atom Feed">
                    <i class="icon icon-rss black"></i>
                </a>
            
        </nav>
        
            <p><em><a href='https://github.com/iromli/groovematic'>Use the source, Luke!</a></em></p>
        
    </div>
</footer>
        
    
            <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        
    
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'groovematic'; // required: replace example with your forum shortname
            if (window.location.hostname != 'localhost') {
                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function () {
                    var s = document.createElement('script'); s.async = true;
                    s.type = 'text/javascript';
                    s.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);}());
            }
        </script>
    
    
    <script>
        !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
    </script>





    <script type="text/javascript">
        (function() {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = 'https://apis.google.com/js/plusone.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>


    </body>
</html>